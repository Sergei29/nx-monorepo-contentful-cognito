# NxReactMonorepo

<a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a>

âœ¨ **This workspace has been generated by [Nx, Smart Monorepos Â· Fast CI.](https://nx.dev)** âœ¨

### Setup Testing with Vite

1. remove all jest related packages
2. $ `nx add @nx/vite`
3. $ `npx nx g @nx/vite:vitest --project=nx-react-monorepo --testEnvironment=jsdom --uiFramework=react`
4. Install testing dependencies for React, Vite and Canvas

- $ `yarn add -D @testing-library/react @testing-library/jest-dom @vitejs/plugin-react vite-tsconfig-paths vitest-canvas-mock`

That's a lot of dependencies ðŸ˜„ , so let's break them down:

- `"@testing-library/react"`: A library for testing React components. It provides utilities to simulate user interactions and query elements in a way that's more aligned with how users interact with your app.

- `"@testing-library/jest-dom"`: A set of custom matchers that makes it easier to assert how your components should behave in the DOM.

- `"@vitejs/plugin-react"`: The official Vite plugin to support React. This plugin enables features like Fast Refresh in a Vite + React development setup.

- `"vite-tsconfig-paths"`: A Vite plugin that enables support for TypeScript's paths and baseUrl configuration options. This is useful when you want to set up custom path aliases in a TypeScript project using Vite.

- `"vitest-canvas-mock"`: Mocks the canvas API when running unit tests with vitest.

5. Add a test setup file

```ts
import { afterEach, expect } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';
// Option for using mocking canvas testing
import 'vitest-canvas-mock';

expect.extend(matchers);

// runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
});

// Add Default Functions, for example providers as here:
// https://testing-library.com/docs/react-testing-library/setup/#custom-render

/* eslint-disable @typescript-eslint/no-empty-function */
const noop = () => {};
Object.defineProperty(window, 'scrollTo', { value: noop, writable: true });
```

6. Update Vite Config to support test setup and reference libraries in MonoRepo

```ts
/// <reference types='vitest' />
/// <reference types="vite/client" />

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { nxViteTsPaths } from '@nx/vite/plugins/nx-tsconfig-paths.plugin';

export default defineConfig({
  root: __dirname,
  cacheDir: '../../node_modules/.vite/apps/nx-react-monorepo',

  plugins: [react(), nxViteTsPaths()],

  // Uncomment this if you are using workers.
  // worker: {
  //  plugins: [ nxViteTsPaths() ],
  // },

  test: {
    root: __dirname,
    globals: true,
    cache: {
      dir: '../../node_modules/.vitest',
    },
    environment: 'jsdom',
    include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}', '__tests__/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    deps: {
      // Required for vitest-canvas-mock
      inline: ['vitest-canvas-mock'],
    },
    setupFiles: ['./test-setup.ts'],
    reporters: ['default'],
    coverage: {
      reportsDirectory: '../../coverage/apps/nx-react-monorepo',
      provider: 'v8',
    },
  },
});
```

7. make sure the project.json config reflects the test command:

```json
{
  "name": "nx-react-monorepo",
  // ...
  "targets": {
    "test": {
      "executor": "@nx/vite:test",
      "options": {
        "config": "apps/nx-react-monorepo/vite.config.ts"
      },
      "configurations": {
        "watch": {
          "watch": true
        }
      }
    }
  }
}
```

8. then you can write unit tests in `nx-react-monorepo/__tests/` directory
9. $ `nx test nx-react-monorepo`

### TailwindCSS

1. Install and configure Tailwind in an Nx workspace
   `yarn add -D tailwindcss@latest postcss@latest autoprefixer@latest`
2. Go to our Next.js application dir

- `cd apps/nx-react-monorepo/`
- `npx tailwindcss init -p`

That should generate both of the configuration files directly into the root of our Next.js application.

3. Make sure you adjust our `postcss.config.js` to properly point to our tailwind config file.

```js
// apps/nx-react-monorepo/postcss.config.js
const { join } = require('path');

module.exports = {
  plugins: {
    tailwindcss: {
      config: join(__dirname, 'tailwind.config.js'),
    },
    autoprefixer: {},
  },
};
```

4. Update config `tailwind.config.js`

```js
// apps/nx-react-monorepo/tailwind.config.js
const { createGlobPatternsForDependencies } = require('@nx/react/tailwind');
const { join } = require('path');

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [join(__dirname, '{src,pages,components,app}/**/*!(*.stories|*.spec).{ts,tsx,html}'), ...createGlobPatternsForDependencies(__dirname)],
  theme: {
    extend: {
      gridTemplateColumns: {
        gallery: 'repeat(auto-fit, minmax(250px, 1fr))',
        pages: 'repeat(auto-fit, minmax(350px, 1fr))',
      },
      fontFamily: {
        arOneSans: ['var(--font-ar-one-sans)', 'sans-serif'],
        albertSans: ['var(--font-albert-sans)', 'sans-serif'],
      },
      fontSize: {
        '2xs': ['0.5rem', '0.75rem'],
      },
      screens: {
        xs: '475px',
      },
    },
  },
  plugins: [],
};
```

5. update `styles.css` as per tw docs.

### Troubleshoot

1. always before commit run

- $ `nx format:write`
- $ `nx affected -t lint test build e2e-ci`

it may show occasionally the failure related to such directories as

- `.nx` => if so run `nx reset` it will flush the old cached files
- `/apps/nx-react-monorepo/.next/...` or `/apps/nx-react-monorepo/out/...` - delete these directories and re-run the tests.

### E2E Cypress

- runs well locally in both dev/prod modes.
- Important to note: in CI pipeline run by gh actions, it randomly fails with visiting the page url, (see below)
  so far - the only remedy found is to clear cache and re-run the gh workflow jobs
- It may worth to consider to run clear cache job prior the workflow; to specify in CI `.yaml`

```yaml
  Running:  app.cy.ts                                                                       (1 of 1)


  my-happy-bunch-e2e
    1) "before each" hook for "should display welcome message"


  0 passing (279ms)
  1 failing

  1) my-happy-bunch-e2e
       "before each" hook for "should display welcome message":
     CypressError: `cy.visit()` failed trying to load:

http://localhost:3000/

The response we received from your web server was:

  > 404: Not Found

This was considered a failure because the status code was not `2xx`.
```

- There is a possible fix to that CI failure by adding `wait-on` directive. [see Cypress docs for gh actions](https://learn.cypress.io/tutorials/running-our-tests-with-github-actions)

```yaml
# ... prev ...
- uses: nrwl/nx-set-shas@v4
  with:
    wait-on: 'http://localhost:3000'

- run: yarn nx-cloud record -- nx format:check
- run: yarn nx affected -t lint test build e2e-ci
```

## Integrate with editors

Enhance your Nx experience by installing [Nx Console](https://nx.dev/nx-console) for your favorite editor. Nx Console
provides an interactive UI to view your projects, run tasks, generate code, and more! Available for VSCode, IntelliJ and
comes with a LSP for Vim users.

## Start the application

Run `npx nx dev nx-react-monorepo` to start the development server. Happy coding!

## Build for production

Run `npx nx build nx-react-monorepo` to build the application. The build artifacts are stored in the output directory (e.g. `dist/` or `build/`), ready to be deployed.

## Running tasks

To execute tasks with Nx use the following syntax:

```
npx nx <target> <project> <...options>
```

You can also run multiple targets:

```
npx nx run-many -t <target1> <target2>
```

..or add `-p` to filter specific projects

```
npx nx run-many -t <target1> <target2> -p <proj1> <proj2>
```

Targets can be defined in the `package.json` or `projects.json`. Learn more [in the docs](https://nx.dev/features/run-tasks).

## Set up CI!

Nx comes with local caching already built-in (check your `nx.json`). On CI you might want to go a step further.

- [Set up remote caching](https://nx.dev/features/share-your-cache)
- [Set up task distribution across multiple machines](https://nx.dev/nx-cloud/features/distribute-task-execution)
- [Learn more how to setup CI](https://nx.dev/recipes/ci)

## Explore the project graph

Run `npx nx graph` to show the graph of the workspace.
It will show tasks that you can run with Nx.

- [Learn more about Exploring the Project Graph](https://nx.dev/core-features/explore-graph)

## Connect with us!

- [Join the community](https://nx.dev/community)
- [Subscribe to the Nx Youtube Channel](https://www.youtube.com/@nxdevtools)
- [Follow us on Twitter](https://twitter.com/nxdevtools)
